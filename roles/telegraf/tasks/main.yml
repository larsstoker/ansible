---
- name: Add InfluxData repository (Rocky Linux)
  yum_repository:
    name: influxdb
    description: InfluxDB Repository - RHEL $releasever
    baseurl: https://repos.influxdata.com/rhel/$releasever/$basearch/stable
    gpgcheck: yes
    gpgkey: https://repos.influxdata.com/influxdb.key
  tags:
    - telegraf-install
  when: ansible_os_family == "Rocky"

- name: Install Telegraf (Rocky Linux)
  yum:
    name: telegraf
    state: latest
  tags:
    - telegraf-install
  when: ansible_os_family == "Rocky"

- name: Enable Telegraf service (Rocky Linux)
  service:
    name: telegraf
    enabled: yes
  tags:
    - telegraf-install
  when: ansible_os_family == "Rocky"

- name: Start Telegraf service (Rocky Linux)
  service:
    name: telegraf
    state: started
  tags:
    - telegraf-install
  when: ansible_os_family == "Rocky"

- name: Copy config (Rocky Linux)
  copy:
    src: telegraf-linux.conf
    dest: /etc/telegraf/telegraf.conf
    owner: root
    group: root
    mode: 0644
    backup: yes
    force: yes
  notify:
    - restart telegraf
  tags:
    - telegraf-configure
  when: ansible_os_family == "Rocky"

- name: Copy config (Windows)
  copy:
    src: telegraf-windows.conf
    dest: /etc/telegraf.conf
    owner: root
    group: root
    mode: 0644
    backup: yes
    force: yes
  tags:
    - telegraf-configure
  notify:
    - restart telegraf
  when: ansible_os_family == "Windows"